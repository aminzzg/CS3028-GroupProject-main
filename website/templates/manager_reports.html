<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Submit Request – {{ role }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
  <style>
    .report-wrapper {
      margin-left: 210px;
      margin-top: 78px;
      padding: 24px;
      background: #EDF3F9;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .report-card {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #d0d7e8;
      padding: 20px;
      margin-bottom: 20px;
      max-width: 720px;
    }

    .report-card h2 {
      margin-top: 0;
      color: #155BCB;
    }

    select,
    textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      padding: 8px 10px;
      font-size: 14px;
      margin-bottom: 12px;
      box-sizing: border-box;
    }

    button {
      border-radius: 8px;
      border: none;
      background: #155BCB;
      color: #fff;
      padding: 8px 16px;
      font-weight: 600;
      cursor: pointer;
    }

    button:hover {
      background: #0d47a1;
    }

    .recipient-block {
      display: none;
    }

    /* Pending requests table formatting */
    .pending-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .pending-table th,
    .pending-table td {
      border: 1px solid #d0d7e8;
      padding: 8px;
      font-size: 14px;
      text-align: left;
    }

    .pending-table th {
      background: #f5f7fb;
    }

    /* Buttons */
    .btn-approve {
      background: #27ae60;
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .btn-reject {
      background: #e74c3c;
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .btn-approve:hover {
      background: #1e8449;
    }

    .btn-reject:hover {
      background: #c0392b;
    }

  </style>
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="icon-container">
      <img src="{{ url_for('static', filename='images/allocations.png') }}" alt="Allocations Icon" class="allocations">
    </div>
    <p class="DashboardTitle">Staff Workload Dashboard</p>
    <p class="database">Database-Driven Team Management System</p>
    </div>
    </div>
  </nav>

  <!-- Same sidebar layout as manager dashboard -->
  <nav class="sidebar">
    <p class="sidebarname">{{ name }}</p>
    <p class="administratorx">{{ role }}</p>
    <img src="{{ url_for('static', filename='images/logout.png') }}" alt="Logout Icon" class="logoutx">
    <a href="{{ url_for('auth.logout') }}" class="logout">Logout</a>

    <!-- Dashboard → Notifications -->
    <a href="{{ url_for('views.notifications') }}" class="sidebar-item">
      <img src="{{ url_for('static', filename='images/courses.png') }}" class="sidebar-icon">
      <span>Notifications</span>
    </a>

    <!-- Course Allocation → Manager Dashboard -->
    <a href="{{ url_for('views.manager_dashboard') }}" class="sidebar-item">
      <img src="{{ url_for('static', filename='images/resources.png') }}" class="sidebar-icon">
      <span>Staff <br> Allocation</span>
    </a>

    <!-- Staff Management → manager_staff_list -->
    <a href="{{ url_for('views.manager_staff_list') }}" class="sidebar-item">
      <img src="{{ url_for('static', filename='images/staff-management.png') }}" class="sidebar-icon">
      <span>Staff <br> Management</span>
    </a>

    <!-- MyTimetable → my_timetable -->
    <a href="{{ url_for('views.my_timetable') }}" class="sidebar-item">
      <img src="{{ url_for('static', filename='images/my-timetable.png') }}" class="sidebar-icon">
      <span>MyTimeTable</span>
    </a>

    <!-- Reporting System Static -->
    <a href="{{ url_for('views.reports') }}" class="sidebar-item">
      <img src="{{ url_for('static', filename='images/analytics.png') }}" class="sidebar-icon">
      <span>Reporting System</span>
    </a>

    <a href="{{ url_for('views.faq') }}" class="sidebar-item">
      <img src="{{ url_for('static', filename='images/faq.png') }}" class="sidebar-icon">
      <span>FAQ</span>
    </a>

  </nav>


  <!-- Page content -->
  <div class="report-wrapper">

    <h1 class="tt-title">Submit a Report / Request</h1>
    <p style="color:#555; margin-top:-4px;">Hi {{ name }}, use this form to contact management or other staff.</p>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=True) %}
    {% if messages %}
    <div class="flashes">
      {% for category, message in messages %}
      <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="report-card">
      <h2>New Request</h2>

      <form method="POST">
        <!-- Request type -->
        <label><strong>Request Type</strong></label>
        <select name="report_type" id="report_type" onchange="updateRecipientSelect()" required>
          <option value="">-- Select type --</option>
          <option value="Course Change Request">Course Change Request</option>
          <option value="Hours Change Request">Hours Change Request</option>
          <option value="Message Staff">Message Staff</option>
          <option value="Course Request">Course Request</option>
          <option value="Course Removal Request">Request Course Removal</option>       
        </select>

        <!-- Course Change: Admin + Manager -->
        <div id="recipient_course" class="recipient-block">
          <label><strong>Send To (Admin or Manager)</strong></label>
          <select name="receiver_id">
            <option value="">-- Select Admin / Manager --</option>
            {% for u in admin_managers %}
            <option value="{{ u.StaffID }}">{{ u.Name }} ({{ u.Position }})</option>
            {% endfor %}
          </select>
        </div>

        <!-- Hours Change: Admin only -->
        <div id="recipient_hours" class="recipient-block">
          <label><strong>Send To (Admin only)</strong></label>
          <select name="receiver_id">
            <option value="">-- Select Admin --</option>
            {% for u in admins %}
            <option value="{{ u.StaffID }}">{{ u.Name }} ({{ u.Position }})</option>
            {% endfor %}
          </select>
          <label><strong>Extra hours worked</strong></label>
          <input type="number" name="extra_hours" min="1" step="1" placeholder="e.g. 3">
        </div>

        <!-- Message Staff: all staff -->
        <div id="recipient_message" class="recipient-block">
          <label><strong>Send To (Any Staff)</strong></label>
          <select name="receiver_id">
            <option value="">-- Select Staff --</option>
            {% for u in all_staff %}
            <option value="{{ u.StaffID }}">{{ u.Name }} ({{ u.Position }})</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Course Request: select a course -->
        <div id="recipient_course_request" class="recipient-block">
          <label><strong>Select a Course</strong></label>
          <select name="course_id" id="course_id">
            <option value="">-- Select Course --</option>
            {% for c in courses %}
            <option value="{{ c.CourseID }}">{{ c.CourseName }} ({{ c.CourseID }})</option>
            {% endfor %}
          </select>
        </div>

        <div id="recipient_course_removal" class="recipient-block">
          <label><strong>Select a Course to Remove</strong></label>
          <select name="course_removal_id" id="course_removal_id">
            <option value="">-- Select Course --</option>
            {% for c in courses %}
            <option value="{{ c.CourseID }}">{{ c.CourseName }} ({{ c.CourseID }})</option>
            {% endfor %}
          </select>
        </div>


        <label><strong>Message</strong></label>
        <textarea name="message" rows="4" placeholder="Describe your request..." required></textarea>

        <button type="submit">Send Request</button>
      </form>
    </div>
  </div>

  

  {% if pending_requests %}
    <div class="report-card">
      <h2>Pending Course Requests</h2>

      <table class="pending-table">
        <thead>
          <tr>
            <th>Staff</th>
            <th>Course</th>
            <th>Requested At</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in pending_requests %}
          <tr>
            <td>{{ r.StaffName }}</td>
            <td>{{ r.CourseName }} ({{ r.CourseID }})</td>
            <td>{{ r.RequestedAt }}</td>
            <td>{{ r.Notes or "" }}</td>
            <td>
              <form method="POST"
                    action="{{ url_for('views.course_request_action', request_id=r.RequestID) }}"
                    style="display:inline;">
                <button type="submit" name="action" value="approve" class="btn-approve">Approve</button>
              </form>
              <form method="POST"
                    action="{{ url_for('views.course_request_action', request_id=r.RequestID) }}"
                    style="display:inline;">
                <button type="submit" name="action" value="reject" class="btn-reject">Reject</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="report-card">
      <h2>Pending Course Requests</h2>
      <p>No pending course requests.</p>
    </div>
    {% endif %}


  <script>
    function updateRecipientSelect() {
      const type = document.getElementById('report_type').value;

      const blocks = {
        "Course Change Request": document.getElementById('recipient_course'),
        "Hours Change Request": document.getElementById('recipient_hours'),
        "Message Staff": document.getElementById('recipient_message'),
        "Course Request": document.getElementById('recipient_course_request'),
        "Course Removal Request": document.getElementById('recipient_course_removal')
      };

      // Hide all blocks & disable selects
      Object.values(blocks).forEach(block => {
        if (!block) return;
        block.style.display = 'none';
        const sel = block.querySelector('select');
        if (sel) sel.disabled = true;
      });

      // Show proper block & enable its select
      if (blocks[type]) {
        blocks[type].style.display = 'block';
        const sel = blocks[type].querySelector('select');
        if (sel) sel.disabled = false;
      }
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const currentPath = window.location.pathname;

      document.querySelectorAll('.sidebar .sidebar-item[href]').forEach(link => {
        try {
          const linkPath = new URL(link.href).pathname;
          if (linkPath === currentPath) {
            link.classList.add('active');
          }
        } catch (e) {
          // ignore bad hrefs like "#"
        }
      });
    });
  </script>

</body>

</html>